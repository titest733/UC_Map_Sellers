import pandas as pd
import folium

# --- PARAM√àTRES ---
EXCEL_PATH = "BDD_acteurs.xlsx"
OUTPUT_HTML = "carte_acteurs.html"

# --- LECTURE DU FICHIER ---
df = pd.read_excel(EXCEL_PATH)
df = df.fillna("-")

df["Couleur de point"] = (
    df["Couleur de point"]
    .astype(str)
    .str.replace(".0", "", regex=False)
    .str.strip()
)

# --- CENTRAGE DE LA CARTE ---
coords = df["PointGPX"].str.split(",", expand=True).astype(float)
map_center = [coords[0].mean(), coords[1].mean()]

# --- CARTE ---
m = folium.Map(
    location=map_center,
    zoom_start=7,
    tiles="CartoDB positron"
)

# --- CAT√âGORIES ---
categories = {
    "0": {
        "label": "Nobatek",
        "color": "orange",
        "icon": "university"
    },
    "1": {
        "label": "Vente de mat√©riaux de r√©emploi",
        "color": "blue",
        "icon": "shopping-cart"
    },
    "2": {
        "label": "Vente + D√©pose soign√©e",
        "color": "red",
        "icon": "wrench"
    },
    "3": {
        "label": "Vente + D√©pose + Reconditionnement",
        "color": "green",
        "icon": "recycle"
    },
    "4": {
        "label": "Vente de mat√©riaux anciens",
        "color": "gray",
        "icon": "archive"
    }
}

# --- CR√âATION DES CALQUES (SANS NOBATEK) ---
layers = {}

for key, cat in categories.items():

    # ‚ùå Nobatek exclu du panneau de cases √† cocher
    if key == "0":
        continue

    layers[key] = folium.FeatureGroup(
        name=f"<i class='fa fa-{cat['icon']}'></i> {cat['label']}",
        show=True
    )
    m.add_child(layers[key])

# --- AJOUT DES POINTS ---
for _, row in df.iterrows():

    lat, lon = map(float, row["PointGPX"].split(","))
    cat_key = row["Couleur de point"]
    cat = categories.get(cat_key)

    color = cat["color"] if cat else "gray"
    icon = cat["icon"] if cat else "question-circle"

    popup_html = f"""
    <div style="font-family: Arial; font-size: 13px;">
        <h4>{row['Nom entreprise']}</h4>
        <b>{row['D√©nomination']}</b><br><br>
        üìû {row['Contact']}<br>
        üìç {row['Adresse']}<br><br>
        <b>Activit√© :</b><br>{row['Activit√©']}<br>
    </div>
    """

    marker = folium.Marker(
        location=[lat, lon],
        tooltip=row["Nom entreprise"],
        popup=folium.Popup(popup_html, max_width=350),
        icon=folium.Icon(
            color=color,
            icon=icon,
            prefix="fa"
        )
    )

    # üëâ Ajout uniquement aux calques visibles
    if cat_key in layers:
        marker.add_to(layers[cat_key])
    else:
        # Nobatek et non class√©s restent visibles sur la carte
        marker.add_to(m)

# --- AJOUT DES CALQUES √Ä LA CARTE ---
for layer in layers.values():
    layer.add_to(m)

# --- PANNEAU DE CASES √Ä COCHER ---
folium.LayerControl(collapsed=False).add_to(m)

# --- EXPORT ---
m.save(OUTPUT_HTML)
print(f"Carte g√©n√©r√©e : {OUTPUT_HTML}")
